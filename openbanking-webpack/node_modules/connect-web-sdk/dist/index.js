"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Connect = void 0;

require("core-js/stable/url");

var _constants = require("./constants");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var evHandlers;
var onMessageFn;
var connectUrl;
var iframe;
var metaEl;
var targetWindow;
var connectOrigin;
var popupWindow;
var defaultEventHandlers = {
  onLoad: function onLoad() {},
  onUser: function onUser(event) {},
  onRoute: function onRoute(event) {}
};
var defaultPopupOptions = {
  toolbar: 'no',
  location: 'no',
  status: 'no',
  menubar: 'no',
  width: _constants.CONNECT_POPUP_HEIGHT,
  height: _constants.CONNECT_POPUP_WIDTH,
  top: window.self.outerHeight / 2 + window.self.screenY - _constants.CONNECT_POPUP_HEIGHT / 2,
  left: window.self.outerWidth / 2 + window.self.screenX - _constants.CONNECT_POPUP_WIDTH / 2
};
var Connect = {
  destroy: function destroy() {
    if (iframe && iframe.parentNode) {
      iframe.parentNode.removeChild(iframe);
    }

    if (metaEl && metaEl.parentNode) {
      metaEl.parentNode.removeChild(metaEl);
    }

    if (!iframe && targetWindow) {
      targetWindow.close();
    }

    iframe = undefined;
    metaEl = undefined;
    window.removeEventListener('message', onMessageFn);
  },
  launch: function launch(url, eventHandlers) {
    var _this = this;

    var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
    connectUrl = url;
    evHandlers = _objectSpread(_objectSpread({}, defaultEventHandlers), eventHandlers);
    connectOrigin = new URL(connectUrl).origin;

    if (options.popup) {
      var popupOptions = _objectSpread(_objectSpread({}, defaultPopupOptions), options.popupOptions);

      var _popupWindow = window.open(connectUrl, 'targetWindow', "toolbar=".concat(defaultPopupOptions.toolbar, ",location=").concat(defaultPopupOptions.location, ",status=").concat(defaultPopupOptions.status, ",menubar=").concat(defaultPopupOptions.menubar, ",width=").concat(popupOptions.width, ",height=").concat(popupOptions.height, ",top=").concat(popupOptions.top, ",left=").concat(popupOptions.left));

      if (!_popupWindow) {
        evHandlers.onError({
          reason: 'error',
          code: 1403
        });
      } else {
        targetWindow = _popupWindow;

        _popupWindow.focus();

        this.initPostMessage(options);
        evHandlers.onLoad && evHandlers.onLoad();
      }

      return _popupWindow;
    } else {
      if (iframe && iframe.parentNode) {
        throw new Error('You must destroy the iframe before you can open a new one. Call "destroy()"');
      }

      var metaArray = document.querySelectorAll('meta[name="viewport"]');

      if (metaArray.length === 0) {
        metaEl = document.createElement('meta');
        metaEl.setAttribute('name', 'viewport');
        metaEl.setAttribute('content', 'initial-scale=1');
        document.head.appendChild(metaEl);
      }

      iframe = document.createElement('iframe');
      iframe.src = connectUrl;
      iframe.setAttribute('id', _constants.IFRAME_ID);
      iframe.setAttribute('frameborder', '0');
      iframe.setAttribute('scrolling', 'no'); // NOTE: update overlay

      if (options.overlay) {
        iframe.setAttribute('style', "background: ".concat(options.overlay, ";"));
      }

      if (options.node) {
        options.node.appendChild(iframe);
      } else {
        // NOTE: attach to selector if specified
        var parentEl = !!options.selector ? document.querySelector(options.selector) : document.body;

        if (parentEl) {
          parentEl.appendChild(iframe);
        } else {
          console.warn("Couldn't find any elements matching \"".concat(options.selector, "\", appending \"iframe\" to \"body\" instead."));
          document.body.appendChild(iframe);
        }
      }

      iframe.onload = function () {
        targetWindow = iframe.contentWindow;

        _this.initPostMessage(options);

        evHandlers.onLoad && evHandlers.onLoad();
      };

      return null;
    }
  },
  initPostMessage: function initPostMessage(options) {
    var _this2 = this;

    // NOTE: ping connect until it responds
    var intervalId = setInterval(function () {
      return _this2.postMessage({
        type: _constants.PING_EVENT,
        selector: options.selector,
        sdkVersion: _constants.CONNECT_SDK_VERSION,
        platform: "".concat(options.popup ? _constants.PLATFORM_POPUP : _constants.PLATFORM_IFRAME)
      });
    }, 1000);

    onMessageFn = function onMessageFn(event) {
      var payload = event.data.data;
      var eventType = event.data.type; // NOTE: make sure it's Connect and not a bad actor

      if (event.origin === connectOrigin) {
        // NOTE: actively pinging connect while it's displayed in a popup allows us to recover the
        // session if the user refreshes the popup
        if (eventType === _constants.ACK_EVENT && !options.popup) {
          clearInterval(intervalId);
        } else if (eventType === _constants.URL_EVENT) {
          _this2.openPopupWindow(event.data.url);
        } else if (eventType === _constants.DONE_EVENT) {
          evHandlers.onDone(payload);

          _this2.destroy();
        } else if (eventType === _constants.CANCEL_EVENT) {
          evHandlers.onCancel(payload);

          _this2.destroy();
        } else if (eventType === _constants.ERROR_EVENT) {
          evHandlers.onError(payload);

          _this2.destroy();
        } else if (eventType === _constants.ROUTE_EVENT) {
          evHandlers.onRoute && evHandlers.onRoute(payload);
        } else if (eventType === _constants.USER_EVENT) {
          evHandlers.onUser && evHandlers.onUser(payload);
        } else if (eventType === _constants.CLOSE_POPUP_EVENT) {
          var _popupWindow2;

          (_popupWindow2 = popupWindow) === null || _popupWindow2 === void 0 ? void 0 : _popupWindow2.close();
        }
      }
    };

    window.addEventListener('message', onMessageFn);
  },
  openPopupWindow: function openPopupWindow(url) {
    var _this3 = this;

    var top = window.self.outerHeight / 2 + window.self.screenY - _constants.POPUP_HEIGHT / 2;
    var left = window.self.outerWidth / 2 + window.self.screenX - _constants.POPUP_WIDTH / 2;
    popupWindow = window.open(url, 'targetWindow', "toolbar=no,location=no,status=no,menubar=no,width=".concat(_constants.POPUP_WIDTH, ",height=").concat(_constants.POPUP_HEIGHT, ",top=").concat(top, ",left=").concat(left));

    if (popupWindow) {
      popupWindow.focus();
      var intervalId = setInterval(function () {
        var _popupWindow3;

        // clear itself if window no longer exists or has been closed
        if ((_popupWindow3 = popupWindow) !== null && _popupWindow3 !== void 0 && _popupWindow3.closed) {
          // window closed, notify connect
          clearInterval(intervalId);

          _this3.postMessage({
            type: _constants.WINDOW_EVENT,
            closed: true,
            blocked: false
          });
        }
      }, 1000);
    } else {
      this.postMessage({
        type: _constants.WINDOW_EVENT,
        closed: true,
        blocked: true
      });
    }
  },
  postMessage: function postMessage(data) {
    var _targetWindow;

    (_targetWindow = targetWindow) === null || _targetWindow === void 0 ? void 0 : _targetWindow.postMessage(data, connectUrl);
  }
};
exports.Connect = Connect;

(function applyStyles() {
  if (!document.getElementById(_constants.STYLES_ID)) {
    var style = document.createElement('style');
    style.id = _constants.STYLES_ID;
    style.type = 'text/css';
    style.innerHTML = "#".concat(_constants.IFRAME_ID, " {\n      position: absolute;\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      z-index: 10;\n      background: rgba(0,0,0,0.8);\n    }");
    document.getElementsByTagName('head')[0].appendChild(style);
  }
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJldkhhbmRsZXJzIiwib25NZXNzYWdlRm4iLCJjb25uZWN0VXJsIiwiaWZyYW1lIiwibWV0YUVsIiwidGFyZ2V0V2luZG93IiwiY29ubmVjdE9yaWdpbiIsInBvcHVwV2luZG93IiwiZGVmYXVsdEV2ZW50SGFuZGxlcnMiLCJvbkxvYWQiLCJvblVzZXIiLCJldmVudCIsIm9uUm91dGUiLCJkZWZhdWx0UG9wdXBPcHRpb25zIiwidG9vbGJhciIsImxvY2F0aW9uIiwic3RhdHVzIiwibWVudWJhciIsIndpZHRoIiwiQ09OTkVDVF9QT1BVUF9IRUlHSFQiLCJoZWlnaHQiLCJDT05ORUNUX1BPUFVQX1dJRFRIIiwidG9wIiwid2luZG93Iiwic2VsZiIsIm91dGVySGVpZ2h0Iiwic2NyZWVuWSIsImxlZnQiLCJvdXRlcldpZHRoIiwic2NyZWVuWCIsIkNvbm5lY3QiLCJkZXN0cm95IiwicGFyZW50Tm9kZSIsInJlbW92ZUNoaWxkIiwiY2xvc2UiLCJ1bmRlZmluZWQiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwibGF1bmNoIiwidXJsIiwiZXZlbnRIYW5kbGVycyIsIm9wdGlvbnMiLCJVUkwiLCJvcmlnaW4iLCJwb3B1cCIsInBvcHVwT3B0aW9ucyIsIm9wZW4iLCJvbkVycm9yIiwicmVhc29uIiwiY29kZSIsImZvY3VzIiwiaW5pdFBvc3RNZXNzYWdlIiwiRXJyb3IiLCJtZXRhQXJyYXkiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJsZW5ndGgiLCJjcmVhdGVFbGVtZW50Iiwic2V0QXR0cmlidXRlIiwiaGVhZCIsImFwcGVuZENoaWxkIiwic3JjIiwiSUZSQU1FX0lEIiwib3ZlcmxheSIsIm5vZGUiLCJwYXJlbnRFbCIsInNlbGVjdG9yIiwicXVlcnlTZWxlY3RvciIsImJvZHkiLCJjb25zb2xlIiwid2FybiIsIm9ubG9hZCIsImNvbnRlbnRXaW5kb3ciLCJpbnRlcnZhbElkIiwic2V0SW50ZXJ2YWwiLCJwb3N0TWVzc2FnZSIsInR5cGUiLCJQSU5HX0VWRU5UIiwic2RrVmVyc2lvbiIsIkNPTk5FQ1RfU0RLX1ZFUlNJT04iLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX1BPUFVQIiwiUExBVEZPUk1fSUZSQU1FIiwicGF5bG9hZCIsImRhdGEiLCJldmVudFR5cGUiLCJBQ0tfRVZFTlQiLCJjbGVhckludGVydmFsIiwiVVJMX0VWRU5UIiwib3BlblBvcHVwV2luZG93IiwiRE9ORV9FVkVOVCIsIm9uRG9uZSIsIkNBTkNFTF9FVkVOVCIsIm9uQ2FuY2VsIiwiRVJST1JfRVZFTlQiLCJST1VURV9FVkVOVCIsIlVTRVJfRVZFTlQiLCJDTE9TRV9QT1BVUF9FVkVOVCIsImFkZEV2ZW50TGlzdGVuZXIiLCJQT1BVUF9IRUlHSFQiLCJQT1BVUF9XSURUSCIsImNsb3NlZCIsIldJTkRPV19FVkVOVCIsImJsb2NrZWQiLCJhcHBseVN0eWxlcyIsImdldEVsZW1lbnRCeUlkIiwiU1RZTEVTX0lEIiwic3R5bGUiLCJpZCIsImlubmVySFRNTCIsImdldEVsZW1lbnRzQnlUYWdOYW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRUE7Ozs7Ozs7O0FBc0JBLElBQUlBLFVBQUo7QUFDQSxJQUFJQyxXQUFKO0FBQ0EsSUFBSUMsVUFBSjtBQUNBLElBQUlDLE1BQUo7QUFDQSxJQUFJQyxNQUFKO0FBQ0EsSUFBSUMsWUFBSjtBQUNBLElBQUlDLGFBQUo7QUFDQSxJQUFJQyxXQUFKO0FBV0EsSUFBTUMsb0JBQXlCLEdBQUc7QUFDaENDLEVBQUFBLE1BQU0sRUFBRSxrQkFBTSxDQUFFLENBRGdCO0FBRWhDQyxFQUFBQSxNQUFNLEVBQUUsZ0JBQUNDLEtBQUQsRUFBZ0IsQ0FBRSxDQUZNO0FBR2hDQyxFQUFBQSxPQUFPLEVBQUUsaUJBQUNELEtBQUQsRUFBOEIsQ0FBRTtBQUhULENBQWxDO0FBc0RBLElBQU1FLG1CQUFtQixHQUFHO0FBQzFCQyxFQUFBQSxPQUFPLEVBQUUsSUFEaUI7QUFFMUJDLEVBQUFBLFFBQVEsRUFBRSxJ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Q0FBQ0UsV0FBTCxDQUFpQjtBQUNmQyxZQUFBQSxJQUFJLEVBQUUwQix1QkFEUztBQUVmRCxZQUFBQSxNQUFNLEVBQUUsSUFGTztBQUdmRSxZQUFBQSxPQUFPLEVBQUU7QUFITSxXQUFqQjtBQUtEO0FBQ0YsT0FYNkIsRUFXM0IsSUFYMkIsQ0FBOUI7QUFZRCxLQWRELE1BY087QUFDTCxXQUFLNUIsV0FBTCxDQUFpQjtBQUNmQyxRQUFBQSxJQUFJLEVBQUUwQix1QkFEUztBQUVmRCxRQUFBQSxNQUFNLEVBQUUsSUFGTztBQUdmRSxRQUFBQSxPQUFPLEVBQUU7QUFITSxPQUFqQjtBQUtEO0FBQ0YsR0FuTDZCO0FBcUw5QjVCLEVBQUFBLFdBckw4Qix1QkFxTGxCUyxJQXJMa0IsRUFxTFA7QUFBQTs7QUFDckIscUJBQUE5RSxZQUFZLFVBQVosc0RBQWNxRSxXQUFkLENBQTBCUyxJQUExQixFQUFnQ2pGLFVBQWhDO0FBQ0Q7QUF2TDZCLENBQXpCOzs7QUEwTFAsQ0FBQyxTQUFTcUcsV0FBVCxHQUF1QjtBQUN0QixNQUFJLENBQUNsRCxRQUFRLENBQUNtRCxjQUFULENBQXdCQyxvQkFBeEIsQ0FBTCxFQUF5QztBQUN2QyxRQUFNQyxLQUFLLEdBQUdyRCxRQUFRLENBQUNHLGFBQVQsQ0FBdUIsT0FBdkIsQ0FBZDtBQUNBa0QsSUFBQUEsS0FBSyxDQUFDQyxFQUFOLEdBQVdGLG9CQUFYO0FBQ0FDLElBQUFBLEtBQUssQ0FBQy9CLElBQU4sR0FBYSxVQUFiO0FBQ0ErQixJQUFBQSxLQUFLLENBQUNFLFNBQU4sY0FBc0IvQyxvQkFBdEI7QUFTQVIsSUFBQUEsUUFBUSxDQUFDd0Qsb0JBQVQsQ0FBOEIsTUFBOUIsRUFBc0MsQ0FBdEMsRUFBeUNsRCxXQUF6QyxDQUFxRCtDLEtBQXJEO0FBQ0Q7QUFDRixDQWhCRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnY29yZS1qcy9zdGFibGUvdXJsJztcblxuaW1wb3J0IHtcbiAgSUZSQU1FX0lELFxuICBQT1BVUF9XSURUSCxcbiAgUE9QVVBfSEVJR0hULFxuICBDT05ORUNUX1BPUFVQX0hFSUdIVCxcbiAgQ09OTkVDVF9QT1BVUF9XSURUSCxcbiAgQUNLX0VWRU5ULFxuICBDQU5DRUxfRVZFTlQsXG4gIFVSTF9FVkVOVCxcbiAgRE9ORV9FVkVOVCxcbiAgRVJST1JfRVZFTlQsXG4gIFBJTkdfRVZFTlQsXG4gIFdJTkRPV19FVkVOVCxcbiAgUk9VVEVfRVZFTlQsXG4gIFVTRVJfRVZFTlQsXG4gIFNUWUxFU19JRCxcbiAgQ09OTkVDVF9TREtfVkVSU0lPTixcbiAgQ0xPU0VfUE9QVVBfRVZFTlQsXG4gIFBMQVRGT1JNX1BPUFVQLFxuICBQTEFURk9STV9JRlJBTUUsXG59IGZyb20gJy4vY29uc3RhbnRzJztcblxubGV0IGV2SGFuZGxlcnM6IENvbm5lY3RFdmVudEhhbmRsZXJzO1xubGV0IG9uTWVzc2FnZUZuOiBhbnk7XG5sZXQgY29ubmVjdFVybDogc3RyaW5nO1xubGV0IGlmcmFtZTogYW55O1xubGV0IG1ldGFFbDogYW55O1xubGV0IHRhcmdldFdpbmRvdzogV2luZG93O1xubGV0IGNvbm5lY3RPcmlnaW46IHN0cmluZztcbmxldCBwb3B1cFdpbmRvdzogV2luZG93IHwgbnVsbDtcblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0RXZlbnRIYW5kbGVycyB7XG4gIG9uRG9uZTogKGV2ZW50OiBDb25uZWN0RG9uZUV2ZW50KSA9PiB2b2lkO1xuICBvbkNhbmNlbDogKGV2ZW50OiBDb25uZWN0Q2FuY2VsRXZlbnQpID0+IHZvaWQ7XG4gIG9uRXJyb3I6IChldmVudDogQ29ubmVjdEVycm9yRXZlbnQpID0+IHZvaWQ7XG4gIG9uUm91dGU/OiAoZXZlbnQ6IENvbm5lY3RSb3V0ZUV2ZW50KSA9PiB2b2lkO1xuICBvblVzZXI/OiAoZXZlbnQ6IGFueSkgPT4gdm9pZDtcbiAgb25Mb2FkPzogKCkgPT4gdm9pZDtcbn1cblxuY29uc3QgZGVmYXVsdEV2ZW50SGFuZGxlcnM6IGFueSA9IHtcbiAgb25Mb2FkOiAoKSA9PiB7fSxcbiAgb25Vc2VyOiAoZXZlbnQ6IGFueSkgPT4ge30sXG4gIG9uUm91dGU6IChldmVudDogQ29ubmVjdFJvdXRlRXZlbnQpID0+IHt9LFxufTtcblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0UHJvcHMge1xuICBjb25uZWN0VXJsOiBzdHJpbmc7XG4gIGV2ZW50SGFuZGxlcnM6IENvbm5lY3RFdmVudEhhbmRsZXJzO1xuICBsaW5raW5nVXJpPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3RDYW5jZWxFdmVudCB7XG4gIGNvZGU6IG51bWJlcjtcbiAgcmVhc29uOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdEVycm9yRXZlbnQge1xuICBjb2RlOiBudW1iZXI7XG4gIHJlYXNvbjogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3REb25lRXZlbnQge1xuICBjb2RlOiBudW1iZXI7XG4gIHJlYXNvbjogc3RyaW5nO1xuICByZXBvcnREYXRhOiBbXG4gICAge1xuICAgICAgcG9ydGZvbGlvSWQ6IHN0cmluZztcbiAgICAgIHR5cGU6IHN0cmluZztcbiAgICAgIHJlcG9ydElkOiBzdHJpbmc7XG4gICAgfVxuICBdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3RSb3V0ZUV2ZW50IHtcbiAgc2NyZWVuOiBzdHJpbmc7XG4gIHBhcmFtczogYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3RPcHRpb25zIHtcbiAgc2VsZWN0b3I/OiBzdHJpbmc7XG4gIG5vZGU/OiBOb2RlO1xuICBvdmVybGF5Pzogc3RyaW5nO1xuICBwb3B1cD86IGJvb2xlYW47XG4gIHBvcHVwT3B0aW9ucz86IFBvcHVwT3B0aW9ucztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQb3B1cE9wdGlvbnMge1xuICB3aWR0aD86IG51bWJlcjtcbiAgaGVpZ2h0PzogbnVtYmVyO1xuICB0b3A/OiBudW1iZXI7XG4gIGxlZnQ/OiBudW1iZXI7XG59XG5cbmNvbnN0IGRlZmF1bHRQb3B1cE9wdGlvbnMgPSB7XG4gIHRvb2xiYXI6ICdubycsXG4gIGxvY2F0aW9uOiAnbm8nLFxuICBzdGF0dXM6ICdubycsXG4gIG1lbnViYXI6ICdubycsXG4gIHdpZHRoOiBDT05ORUNUX1BPUFVQX0hFSUdIVCxcbiAgaGVpZ2h0OiBDT05ORUNUX1BPUFVQX1dJRFRILFxuICB0b3A6XG4gICAgd2luZG93LnNlbGYub3V0ZXJIZWlnaHQgLyAyICtcbiAgICB3aW5kb3cuc2VsZi5zY3JlZW5ZIC1cbiAgICBDT05ORUNUX1BPUFVQX0hFSUdIVCAvIDIsXG4gIGxlZnQ6XG4gICAgd2luZG93LnNlbGYub3V0ZXJXaWR0aCAvIDIgKyB3aW5kb3cuc2VsZi5zY3JlZW5YIC0gQ09OTkVDVF9QT1BVUF9XSURUSCAvIDIsXG59O1xuXG5pbnRlcmZhY2UgQ29ubmVjdCB7XG4gIGRlc3Ryb3k6ICgpID0+IHZvaWQ7XG4gIGxhdW5jaDogKFxuICAgIHVybDogc3RyaW5nLFxuICAgIGV2ZW50SGFuZGxlcnM6IENvbm5lY3RFdmVudEhhbmRsZXJzLFxuICAgIG9wdGlvbnM/OiBDb25uZWN0T3B0aW9uc1xuICApID0+IFdpbmRvdyB8IG51bGwgfCB2b2lkO1xuICBpbml0UG9zdE1lc3NhZ2U6IChvcHRpb25zOiBDb25uZWN0T3B0aW9ucykgPT4gdm9pZDtcbiAgb3BlblBvcHVwV2luZG93OiAodXJsOiBzdHJpbmcpID0+IHZvaWQ7XG4gIHBvc3RNZXNzYWdlOiAoZXZlbnQ6IGFueSkgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGNvbnN0IENvbm5lY3Q6IENvbm5lY3QgPSB7XG4gIGRlc3Ryb3koKSB7XG4gICAgaWYgKGlmcmFtZSAmJiBpZnJhbWUucGFyZW50Tm9kZSkge1xuICAgICAgaWZyYW1lLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaWZyYW1lKTtcbiAgICB9XG5cbiAgICBpZiAobWV0YUVsICYmIG1ldGFFbC5wYXJlbnROb2RlKSB7XG4gICAgICBtZXRhRWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChtZXRhRWwpO1xuICAgIH1cblxuICAgIGlmICghaWZyYW1lICYmIHRhcmdldFdpbmRvdykge1xuICAgICAgdGFyZ2V0V2luZG93LmNsb3NlKCk7XG4gICAgfVxuXG4gICAgaWZyYW1lID0gdW5kZWZpbmVkO1xuICAgIG1ldGFFbCA9IHVuZGVmaW5lZDtcblxuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgb25NZXNzYWdlRm4pO1xuICB9LFxuXG4gIGxhdW5jaChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBldmVudEhhbmRsZXJzOiBDb25uZWN0RXZlbnRIYW5kbGVycyxcbiAgICBvcHRpb25zOiBDb25uZWN0T3B0aW9ucyA9IHt9XG4gICkge1xuICAgIGNvbm5lY3RVcmwgPSB1cmw7XG4gICAgZXZIYW5kbGVycyA9IHsgLi4uZGVmYXVsdEV2ZW50SGFuZGxlcnMsIC4uLmV2ZW50SGFuZGxlcnMgfTtcbiAgICBjb25uZWN0T3JpZ2luID0gbmV3IFVSTChjb25uZWN0VXJsKS5vcmlnaW47XG5cbiAgICBpZiAob3B0aW9ucy5wb3B1cCkge1xuICAgICAgY29uc3QgcG9wdXBPcHRpb25zID0geyAuLi5kZWZhdWx0UG9wdXBPcHRpb25zLCAuLi5vcHRpb25zLnBvcHVwT3B0aW9ucyB9O1xuICAgICAgY29uc3QgcG9wdXBXaW5kb3cgPSB3aW5kb3cub3BlbihcbiAgICAgICAgY29ubmVjdFVybCxcbiAgICAgICAgJ3RhcmdldFdpbmRvdycsXG4gICAgICAgIGB0b29sYmFyPSR7ZGVmYXVsdFBvcHVwT3B0aW9ucy50b29sYmFyfSxsb2NhdGlvbj0ke2RlZmF1bHRQb3B1cE9wdGlvbnMubG9jYXRpb259LHN0YXR1cz0ke2RlZmF1bHRQb3B1cE9wdGlvbnMuc3RhdHVzfSxtZW51YmFyPSR7ZGVmYXVsdFBvcHVwT3B0aW9ucy5tZW51YmFyfSx3aWR0aD0ke3BvcHVwT3B0aW9ucy53aWR0aH0saGVpZ2h0PSR7cG9wdXBPcHRpb25zLmhlaWdodH0sdG9wPSR7cG9wdXBPcHRpb25zLnRvcH0sbGVmdD0ke3BvcHVwT3B0aW9ucy5sZWZ0fWBcbiAgICAgICk7XG5cbiAgICAgIGlmICghcG9wdXBXaW5kb3cpIHtcbiAgICAgICAgZXZIYW5kbGVycy5vbkVycm9yKHsgcmVhc29uOiAnZXJyb3InLCBjb2RlOiAxNDAzIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGFyZ2V0V2luZG93ID0gcG9wdXBXaW5kb3c7XG4gICAgICAgIHBvcHVwV2luZG93LmZvY3VzKCk7XG4gICAgICAgIHRoaXMuaW5pdFBvc3RNZXNzYWdlKG9wdGlvbnMpO1xuICAgICAgICBldkhhbmRsZXJzLm9uTG9hZCAmJiBldkhhbmRsZXJzLm9uTG9hZCgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcG9wdXBXaW5kb3c7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChpZnJhbWUgJiYgaWZyYW1lLnBhcmVudE5vZGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdZb3UgbXVzdCBkZXN0cm95IHRoZSBpZnJhbWUgYmVmb3JlIHlvdSBjYW4gb3BlbiBhIG5ldyBvbmUuIENhbGwgXCJkZXN0cm95KClcIidcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgbGV0IG1ldGFBcnJheSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ21ldGFbbmFtZT1cInZpZXdwb3J0XCJdJyk7XG4gICAgICBpZiAobWV0YUFycmF5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBtZXRhRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdtZXRhJyk7XG4gICAgICAgIG1ldGFFbC5zZXRBdHRyaWJ1dGUoJ25hbWUnLCAndmlld3BvcnQnKTtcbiAgICAgICAgbWV0YUVsLnNldEF0dHJpYnV0ZSgnY29udGVudCcsICdpbml0aWFsLXNjYWxlPTEnKTtcbiAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChtZXRhRWwpO1xuICAgICAgfVxuXG4gICAgICBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTtcblxuICAgICAgaWZyYW1lLnNyYyA9IGNvbm5lY3RVcmw7XG4gICAgICBpZnJhbWUuc2V0QXR0cmlidXRlKCdpZCcsIElGUkFNRV9JRCk7XG4gICAgICBpZnJhbWUuc2V0QXR0cmlidXRlKCdmcmFtZWJvcmRlcicsICcwJyk7XG4gICAgICBpZnJhbWUuc2V0QXR0cmlidXRlKCdzY3JvbGxpbmcnLCAnbm8nKTtcblxuICAgICAgLy8gTk9URTogdXBkYXRlIG92ZXJsYXlcbiAgICAgIGlmIChvcHRpb25zLm92ZXJsYXkpIHtcbiAgICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCBgYmFja2dyb3VuZDogJHtvcHRpb25zLm92ZXJsYXl9O2ApO1xuICAgICAgfVxuXG4gICAgICBpZiAob3B0aW9ucy5ub2RlKSB7XG4gICAgICAgIG9wdGlvbnMubm9kZS5hcHBlbmRDaGlsZChpZnJhbWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gTk9URTogYXR0YWNoIHRvIHNlbGVjdG9yIGlmIHNwZWNpZmllZFxuICAgICAgICBjb25zdCBwYXJlbnRFbCA9ICEhb3B0aW9ucy5zZWxlY3RvclxuICAgICAgICAgID8gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLnNlbGVjdG9yKVxuICAgICAgICAgIDogZG9jdW1lbnQuYm9keTtcbiAgICAgICAgaWYgKHBhcmVudEVsKSB7XG4gICAgICAgICAgcGFyZW50RWwuYXBwZW5kQ2hpbGQoaWZyYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICBgQ291bGRuJ3QgZmluZCBhbnkgZWxlbWVudHMgbWF0Y2hpbmcgXCIke29wdGlvbnMuc2VsZWN0b3J9XCIsIGFwcGVuZGluZyBcImlmcmFtZVwiIHRvIFwiYm9keVwiIGluc3RlYWQuYFxuICAgICAgICAgICk7XG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpZnJhbWUpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmcmFtZS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIHRhcmdldFdpbmRvdyA9IGlmcmFtZS5jb250ZW50V2luZG93O1xuICAgICAgICB0aGlzLmluaXRQb3N0TWVzc2FnZShvcHRpb25zKTtcbiAgICAgICAgZXZIYW5kbGVycy5vbkxvYWQgJiYgZXZIYW5kbGVycy5vbkxvYWQoKTtcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfSxcblxuICBpbml0UG9zdE1lc3NhZ2Uob3B0aW9uczogQ29ubmVjdE9wdGlvbnMpIHtcbiAgICAvLyBOT1RFOiBwaW5nIGNvbm5lY3QgdW50aWwgaXQgcmVzcG9uZHNcbiAgICBjb25zdCBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoXG4gICAgICAoKSA9PlxuICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICB0eXBlOiBQSU5HX0VWRU5ULFxuICAgICAgICAgIHNlbGVjdG9yOiBvcHRpb25zLnNlbGVjdG9yLFxuICAgICAgICAgIHNka1ZlcnNpb246IENPTk5FQ1RfU0RLX1ZFUlNJT04sXG4gICAgICAgICAgcGxhdGZvcm06IGAke29wdGlvbnMucG9wdXAgPyBQTEFURk9STV9QT1BVUCA6IFBMQVRGT1JNX0lGUkFNRX1gLFxuICAgICAgICB9KSxcbiAgICAgIDEwMDBcbiAgICApO1xuXG4gICAgb25NZXNzYWdlRm4gPSAoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGV2ZW50LmRhdGEuZGF0YTtcbiAgICAgIGNvbnN0IGV2ZW50VHlwZSA9IGV2ZW50LmRhdGEudHlwZTtcbiAgICAgIC8vIE5PVEU6IG1ha2Ugc3VyZSBpdCdzIENvbm5lY3QgYW5kIG5vdCBhIGJhZCBhY3RvclxuICAgICAgaWYgKGV2ZW50Lm9yaWdpbiA9PT0gY29ubmVjdE9yaWdpbikge1xuICAgICAgICAvLyBOT1RFOiBhY3RpdmVseSBwaW5naW5nIGNvbm5lY3Qgd2hpbGUgaXQncyBkaXNwbGF5ZWQgaW4gYSBwb3B1cCBhbGxvd3MgdXMgdG8gcmVjb3ZlciB0aGVcbiAgICAgICAgLy8gc2Vzc2lvbiBpZiB0aGUgdXNlciByZWZyZXNoZXMgdGhlIHBvcHVwXG4gICAgICAgIGlmIChldmVudFR5cGUgPT09IEFDS19FVkVOVCAmJiAhb3B0aW9ucy5wb3B1cCkge1xuICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxJZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBVUkxfRVZFTlQpIHtcbiAgICAgICAgICB0aGlzLm9wZW5Qb3B1cFdpbmRvdyhldmVudC5kYXRhLnVybCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBET05FX0VWRU5UKSB7XG4gICAgICAgICAgZXZIYW5kbGVycy5vbkRvbmUocGF5bG9hZCk7XG4gICAgICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBDQU5DRUxfRVZFTlQpIHtcbiAgICAgICAgICBldkhhbmRsZXJzLm9uQ2FuY2VsKHBheWxvYWQpO1xuICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gRVJST1JfRVZFTlQpIHtcbiAgICAgICAgICBldkhhbmRsZXJzLm9uRXJyb3IocGF5bG9hZCk7XG4gICAgICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBST1VURV9FVkVOVCkge1xuICAgICAgICAgIGV2SGFuZGxlcnMub25Sb3V0ZSAmJiBldkhhbmRsZXJzLm9uUm91dGUocGF5bG9hZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBVU0VSX0VWRU5UKSB7XG4gICAgICAgICAgZXZIYW5kbGVycy5vblVzZXIgJiYgZXZIYW5kbGVycy5vblVzZXIocGF5bG9hZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBDTE9TRV9QT1BVUF9FVkVOVCkge1xuICAgICAgICAgIHBvcHVwV2luZG93Py5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgb25NZXNzYWdlRm4pO1xuICB9LFxuXG4gIG9wZW5Qb3B1cFdpbmRvdyh1cmw6IHN0cmluZykge1xuICAgIGNvbnN0IHRvcCA9XG4gICAgICB3aW5kb3cuc2VsZi5vdXRlckhlaWdodCAvIDIgKyB3aW5kb3cuc2VsZi5zY3JlZW5ZIC0gUE9QVVBfSEVJR0hUIC8gMjtcbiAgICBjb25zdCBsZWZ0ID1cbiAgICAgIHdpbmRvdy5zZWxmLm91dGVyV2lkdGggLyAyICsgd2luZG93LnNlbGYuc2NyZWVuWCAtIFBPUFVQX1dJRFRIIC8gMjtcbiAgICBwb3B1cFdpbmRvdyA9IHdpbmRvdy5vcGVuKFxuICAgICAgdXJsLFxuICAgICAgJ3RhcmdldFdpbmRvdycsXG4gICAgICBgdG9vbGJhcj1ubyxsb2NhdGlvbj1ubyxzdGF0dXM9bm8sbWVudWJhcj1ubyx3aWR0aD0ke1BPUFVQX1dJRFRIfSxoZWlnaHQ9JHtQT1BVUF9IRUlHSFR9LHRvcD0ke3RvcH0sbGVmdD0ke2xlZnR9YFxuICAgICk7XG5cbiAgICBpZiAocG9wdXBXaW5kb3cpIHtcbiAgICAgIHBvcHVwV2luZG93LmZvY3VzKCk7XG4gICAgICBjb25zdCBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAvLyBjbGVhciBpdHNlbGYgaWYgd2luZG93IG5vIGxvbmdlciBleGlzdHMgb3IgaGFzIGJlZW4gY2xvc2VkXG4gICAgICAgIGlmIChwb3B1cFdpbmRvdz8uY2xvc2VkKSB7XG4gICAgICAgICAgLy8gd2luZG93IGNsb3NlZCwgbm90aWZ5IGNvbm5lY3RcbiAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpO1xuICAgICAgICAgIHRoaXMucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgdHlwZTogV0lORE9XX0VWRU5ULFxuICAgICAgICAgICAgY2xvc2VkOiB0cnVlLFxuICAgICAgICAgICAgYmxvY2tlZDogZmFsc2UsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0sIDEwMDApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBvc3RNZXNzYWdlKHtcbiAgICAgICAgdHlwZTogV0lORE9XX0VWRU5ULFxuICAgICAgICBjbG9zZWQ6IHRydWUsXG4gICAgICAgIGJsb2NrZWQ6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgcG9zdE1lc3NhZ2UoZGF0YTogYW55KSB7XG4gICAgdGFyZ2V0V2luZG93Py5wb3N0TWVzc2FnZShkYXRhLCBjb25uZWN0VXJsKTtcbiAgfSxcbn07XG5cbihmdW5jdGlvbiBhcHBseVN0eWxlcygpIHtcbiAgaWYgKCFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChTVFlMRVNfSUQpKSB7XG4gICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpO1xuICAgIHN0eWxlLmlkID0gU1RZTEVTX0lEO1xuICAgIHN0eWxlLnR5cGUgPSAndGV4dC9jc3MnO1xuICAgIHN0eWxlLmlubmVySFRNTCA9IGAjJHtJRlJBTUVfSUR9IHtcbiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgICAgIGxlZnQ6IDA7XG4gICAgICB0b3A6IDA7XG4gICAgICB3aWR0aDogMTAwJTtcbiAgICAgIGhlaWdodDogMTAwJTtcbiAgICAgIHotaW5kZXg6IDEwO1xuICAgICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjgpO1xuICAgIH1gO1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQoc3R5bGUpO1xuICB9XG59KSgpO1xuIl19